------------------------------------------------------------------
--
-- [IE3-DI] Digital Circuits Winter Term 2025
--			Exercise 4
--
-- @name:   pmem.vhd
-- @author: 
-- @description: DIRISC program memory module
--				 DESIGN FILE
--
-- (c) 2025 HAW Hamburg
--
-- DIRISC instruction set architecture
-- 
-- REGREG -------------------------------------------------------------------------
-- 15 - 14 - 13 - 12 - 11 - 10 - 09 - 08 - 07 - 06 - 05 - 04 - 03 - 02 - 01 - 00 --
--  0 -  0 - opcode            - X  - src0         - src1         - dst          --
--
-- LOAD ---------------------------------------------------------------------------
-- 15 - 14 - 13 - 12 - 11 - 10 - 09 - 08 - 07 - 06 - 05 - 04 - 03 - 02 - 01 - 00 --
--  1 -  0 - address                                              - dst          --
--
-- STORE --------------------------------------------------------------------------
-- 15 - 14 - 13 - 12 - 11 - 10 - 09 - 08 - 07 - 06 - 05 - 04 - 03 - 02 - 01 - 00 --
--  1 -  1 - address                                              - src0         --
--
-- BRANCH -------------------------------------------------------------------------
-- 15 - 14 - 13 - 12 - 11 - 10 - 09 - 08 - 07 - 06 - 05 - 04 - 03 - 02 - 01 - 00 --
--  0 -  1 - offset                                          - cond              --
--
------------------------------------------------------------------

---------------------------------
-- libraries / packages 
library ieee;
use ieee.std_logic_1164.all;	-- std_logic
use ieee.numeric_std.all;		-- numeric

---------------------------------
-- entity
entity PMEM is
  port (
    -- primary memory port (a)
    clk   : in  std_logic;							-- clock
    PC          : in  std_logic_vector(9 downto 0);	-- PC in
    instruction : out std_logic_vector(15 downto 0)	-- instruction out
    );
end PMEM;

---------------------------------
-- architecture
architecture behavior of PMEM is

-- type declaration
type rom_t is array (natural range <>) of std_logic_vector(15 downto 0);
 
---------------------------------
-- definition of machine code instructions---- Task 2.2
constant pmem: rom_t := (
    -- 1. LOAD r1, x400 (Read Switches into register 1)
    -- Group: 10 | Addr: 100 0000 0010 | Dst: 001
    ("1010000000010001"), 
    
    -- 2. SHL r2, r1 (Shift r1 left by 1 and store in r2)
    -- Group: 00 | Op: 1000 | Bit9: 0 | src1: 000 | src0: 001 | dst: 010
    ("0010000000001010"), 
    
    -- 3. STORE r2, x401 (Write register 2 to LEDs)
    -- Group: 11 | Addr: 100 0000 0000 | src0: 010
    ("1110000000000010"), 
    
    -- 4. BRANCH ALWAYS to address 0 (The infinite loop)
    -- Group: 01 | Offset: 0000000000 | Cond: 1010
    ("0100000000001010"),
    
    -- Padding with NOP
    (x"0000")
);
 
begin

---------------------------------
-- bram process
process(clk)
begin
  if rising_edge(clk) then
	if (to_integer(unsigned(PC)) < pmem'length) then
      instruction <= pmem(to_integer(unsigned(PC)));
    else
      instruction <= (others =>'0');
    end if;
  end if;
end process;

end behavior;
